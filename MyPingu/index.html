<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingu ç…§ç›¸æœº (ç‚¹å‡»äº’åŠ¨ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; height: 100vh; display: flex; justify-content: center; align-items: flex-end; cursor: pointer; }
        
        /* è§†é¢‘ç›´æ¥æ˜¾ç¤ºï¼Œä¸ç¿»è½¬ï¼Œä¿è¯å…¼å®¹æ€§ */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; display: block; }

        #pingu-container {
            position: relative; width: auto; height: 90vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 5vh; z-index: 10; pointer-events: none;
            transition: transform 3s linear;
        }

        #pingu-character { height: 100%; width: auto; max-width: 90vw; object-fit: contain; }
        #stationary-tripod { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); height: 100%; width: auto; display: none; }
        
        #bubble {
            background: white; padding: 15px 25px; border-radius: 20px;
            position: fixed; top: 70px; left: 20px; max-width: 300px;
            font-size: 18px; font-weight: bold; color: #333; z-index: 50;
            opacity: 0; transition: opacity 0.5s; font-family: sans-serif;
            pointer-events: none;
        }
        #bubble::after { content: ''; position: absolute; top: 100%; left: 30px; border-width: 15px 15px 0 0; border-style: solid; border-color: white transparent transparent transparent; }

        #status { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; background: rgba(0,0,0,0.5); 
            padding: 8px 15px; border-radius: 20px; font-size: 14px; z-index: 100;
            pointer-events: none;
        }

        #photo-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; z-index: 200;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #result-photo { max-width: 80%; max-height: 80%; border: 10px solid white; border-radius: 10px; }
        .btn-group { margin-top: 20px; display: flex; gap: 20px; }
        button { padding: 15px 40px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; background: white; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }

        /* åŠ¨ç”»ç±» */
        @keyframes wave-anim { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        .waving { animation: wave-anim 1s infinite; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="input_video" playsinline muted></video>
    </div>
    
    <canvas id="capture_canvas" style="display:none;"></canvas>

    <div id="pingu-container">
        <img id="pingu-character" src="pingu_idle.png" alt="Pingu">
        <img id="stationary-tripod" src="tripod_only.png" alt="Tripod"> 
    </div>

    <div id="bubble">...</div>
    <div id="status">ç‚¹å‡»å±å¹•å¼€å§‹äº’åŠ¨</div>

    <div id="photo-overlay">
        <img id="result-photo" src="">
        <div class="btn-group">
            <button onclick="downloadPhoto()">ğŸ’¾ ä¿å­˜</button>
            <button onclick="location.reload()">ğŸ”„ é‡ç©</button>
        </div>
    </div>

    <script>
        // === æ ¸å¿ƒé€»è¾‘ï¼šå®Œå…¨ç§»é™¤ AIï¼Œæ”¹ä¸ºç‚¹å‡»é©±åŠ¨ ===
        const videoElement = document.getElementById('input_video');
        const pinguChar = document.getElementById('pingu-character');
        const stationaryTripod = document.getElementById('stationary-tripod');
        const pinguContainer = document.getElementById('pingu-container');
        const bubble = document.getElementById('bubble');
        const statusDiv = document.getElementById('status');
        
        // æµç¨‹çŠ¶æ€
        let step = 0; 
        // 0: ç­‰å¾…å¼€å§‹
        // 1: æŒ¥æ‰‹é˜¶æ®µ
        // 2: ç­‰å¾…ç¡®è®¤ (æ¬ä¸‰è„šæ¶)
        // 3: åŠ¨ç”»æ’­æ”¾ä¸­ (ä¸å¯ç‚¹å‡»)

        // éŸ³é¢‘
        let nootAudio = new Audio('noot.mp3');
        let shutterAudio = new Audio('shutter.mp3');
        let christmasAudio = new Audio('merry_christmas.mp3'); christmasAudio.loop = true;
        let cheerAudio = new Audio('cheer.mp3');
        let cryAudio = new Audio('cry.mp3'); cryAudio.loop = true;
        
        let walkInterval = null;

        function speak(text) {
            bubble.innerText = text;
            bubble.style.opacity = 1;
            nootAudio.currentTime = 0;
            nootAudio.play().catch(e=>{});
        }

        // å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.body.addEventListener('click', function(e) {
            // å¦‚æœç‚¹çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘å‰§æƒ…
            if(e.target.tagName === 'BUTTON') return;
            
            nextStoryStep();
        });

        function nextStoryStep() {
            if (step === 0) {
                // ç¬¬ä¸€æ­¥ï¼šç‚¹å‡»å¼€å§‹ï¼ŒPingu æŒ¥æ‰‹
                step = 1;
                statusDiv.innerText = "äº’åŠ¨ä¸­ | ç‚¹å‡»å±å¹•ç»§ç»­";
                speak("ä½ å¥½ï¼å¦‚æœä½ èƒ½çœ‹è§æˆ‘ï¼Œè¯·å†æ¬¡ç‚¹å‡»å±å¹•ï¼");
                pinguContainer.classList.add("waving");
            } 
            else if (step === 1) {
                // ç¬¬äºŒæ­¥ï¼šç‚¹å‡»ç¡®è®¤ï¼ŒPingu å¼€å¿ƒï¼Œå¼€å§‹æ¬ä¸‰è„šæ¶æµç¨‹
                step = 3; // é”å®šçŠ¶æ€ï¼Œé˜²æ­¢ä¹±ç‚¹
                statusDiv.innerText = "å‰§æƒ…æ’­æ”¾ä¸­...";
                pinguContainer.classList.remove("waving");
                
                // æ’­æ”¾å¼€å¿ƒåŠ¨ç”»
                pinguChar.src = "pingu_happy.png";
                speak("å¥½è€¶ï¼é‚£æˆ‘ä»¬æ¥æ‹å¼ ç…§å§ï¼");
                
                // 1.5ç§’åå¼€å§‹èµ°è·¯æ¶è®¾ä¸‰è„šæ¶
                setTimeout(startTripodSequence, 1500);
            }
        }

        // --- ä»¥ä¸‹æ˜¯å®Œå…¨ä¿ç•™çš„åŸç‰ˆåŠ¨ç”»é€»è¾‘ ---

        function startTripodSequence() {
            speak("ç­‰æˆ‘ä¸€ä¸‹å“¦ï¼(å»æ¬ä¸‰è„šæ¶)");
            
            pinguContainer.style.transition = "transform 4s linear";
            pinguContainer.style.transform = "translateX(-200%)"; // èµ°å‡ºå±å¹•

            // èµ°è·¯åŠ¨ç”»
            const walkFrames = ["pingu_walk_left_1.png", "pingu_walk_idle.png", "pingu_walk_left_2.png", "pingu_walk_mid.png"];
            let f = 0;
            walkInterval = setInterval(() => {
                pinguChar.src = walkFrames[f];
                f = (f + 1) % 4;
            }, 200);

            // 4ç§’åèµ°å›æ¥
            setTimeout(() => {
                clearInterval(walkInterval);
                pinguContainer.style.transition = "none";
                // ç¬é—´ç§»å›å³è¾¹å‡†å¤‡èµ°å…¥
                // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥è®©å®ƒå¸¦ç€ä¸‰è„šæ¶æ»‘å›æ¥
                pinguContainer.style.transform = "translateX(0)";
                pinguContainer.style.transition = "transform 4s linear";
                
                let toggle = false;
                walkInterval = setInterval(() => {
                    pinguChar.src = toggle ? "pingu_walk_tripod_1.png" : "pingu_walk_tripod_2.png";
                    toggle = !toggle;
                }, 300);

                speak("æˆ‘å›æ¥å•¦ï¼");

                // èµ°åˆ°ä½ï¼Œæ¶è®¾
                setTimeout(() => {
                    clearInterval(walkInterval);
                    pinguChar.src = "pingu_place_tripod_1.png";
                    speak("å˜¿å’»...");
                    
                    setTimeout(() => {
                        pinguChar.src = "pingu_idle_tripod.png"; 
                        
                        // å¼€å§‹ä¼ é€é—¨å¯¹è¯
                        speak("å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†ï¼Œæ‰€æœ‰çš„åœ£è¯æ ‘éƒ½æ˜¯æˆ‘çš„ä¼ é€é—¨ï¼");
                        setTimeout(() => {
                            speak("æˆ‘è¦èµ°è¿›èº«åçš„åœ£è¯æ ‘ä¼ é€å’¯ï¼");
                            setTimeout(() => {
                                walkIntoTreeSequence();
                            }, 3000);
                        }, 3000);
                    }, 1000);
                }, 4000);
            }, 4000);
        }

        function walkIntoTreeSequence() {
            stationaryTripod.style.display = "block"; // ç•™ä¸‹ä¸‰è„šæ¶
            
            // Pingu å˜å°èµ°è¿œ
            let toggle = false;
            walkInterval = setInterval(() => {
                pinguChar.src = toggle ? "pingu_back_1.png" : "pingu_back_2.png";
                toggle = !toggle;
            }, 250);

            pinguChar.style.transition = "all 3s ease-in";
            pinguChar.style.transform = "translate(-100px, -200px) scale(0.2)";
            pinguChar.style.opacity = "0";

            setTimeout(() => {
                clearInterval(walkInterval);
                speak("ç°åœ¨ï¼Œå¤§å®¶ä¸€èµ·å–Šå‡ºå’’è¯­ï¼");
                
                setTimeout(() => {
                    speak("Merry Christmasï¼");
                    christmasAudio.play().catch(e=>{});
                    
                    setTimeout(() => {
                        speak("æˆ‘æ¥å•¦ï¼");
                        
                        // 8ç§’åœé¡¿
                        setTimeout(() => {
                            speak("å‡†å¤‡å¥½ï¼Œ3ï¼Œ2ï¼Œ1ï¼");
                            setTimeout(() => {
                                takePhoto();
                            }, 3000);
                        }, 8000);
                    }, 3000);
                }, 4000);
            }, 3000);
        }

        function takePhoto() {
            shutterAudio.play();
            cheerAudio.play();
            
            // æˆªå›¾
            const canvas = document.getElementById('capture_canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            // ä¸é•œåƒï¼Œä¿æŒåŸæ ·
            ctx.drawImage(videoElement, 0, 0);
            
            document.getElementById('result-photo').src = canvas.toDataURL('image/png');
            document.getElementById('photo-overlay').style.display = 'flex';
        }

        function downloadPhoto() {
            const a = document.createElement('a');
            a.download = 'pingu_photo.png';
            a.href = document.getElementById('result-photo').src;
            a.click();
        }

        // åˆå§‹åŒ–æ‘„åƒå¤´
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false })
            .then(stream => {
                videoElement.srcObject = stream;
                videoElement.play();
            })
            .catch(err => {
                alert("æ‘„åƒå¤´æ— æ³•å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚");
            });

    </script>
</body>
</html>