<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤äº’å¼ Pingu ç…§ç›¸æœº (è®¡æ•°é˜²æŠ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        /* é¡µé¢åŸºç¡€æ ·å¼ */
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; 
            height: 100vh;
            display: flex; justify-content: center; align-items: flex-end;   
            background-image: url('bg_christmas.png'); 
            background-size: cover; background-position: center bottom; background-repeat: no-repeat;
            box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.2);
        }

        /* æ‘„åƒå¤´å°çª—å£ */
        #video-container { 
            position: absolute; top: 20px; right: 20px; 
            width: 320px; height: 240px; 
            border-radius: 15px; overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 100; background: #000;
        }
        video, #output_canvas { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
        }
        
        /* Pingu å®¹å™¨ */
        #pingu-container {
            position: relative; 
            width: auto; height: 90vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 5vh;
            transform-origin: bottom center;
            animation: breathe 2s ease-in-out infinite; 
            transition: transform 3s linear; 
            z-index: 10;
        }

        /* ç¦æ­¢åŠ¨ç”»ç±» */
        .no-transition { transition: none !important; }

        /* Pingu å›¾ç‰‡ */
        #pingu-character {
            height: 100%; width: auto; max-width: 90vw;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            transition: transform 0.2s; /* é»˜è®¤è¿‡æ¸¡ */
            object-fit: contain;
            position: relative;
            z-index: 2; /* Pingu åœ¨ä¸‰è„šæ¶å‰é¢ */
        }

        /* ç•™åœ¨åŸåœ°çš„ä¸‰è„šæ¶å›¾ç‰‡ */
        #stationary-tripod {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 100%; 
            width: auto;
            z-index: 1; /* åœ¨ Pingu åé¢ */
            display: none; /* é»˜è®¤éšè— */
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }
        
        /* --- å¯¹è¯æ°”æ³¡æ ·å¼ï¼šå°å·§ç²¾è‡´ç‰ˆ --- */
        #bubble {
            background: white; 
            padding: 15px 25px; 
            border-radius: 20px; 
            position: fixed; 
            top: 70px;  
            left: 20px; 
            width: auto; 
            max-width: 300px; 
            font-size: 21px; 
            font-weight: bold; 
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            opacity: 0; transition: opacity 0.5s;
            z-index: 50; 
            text-align: left; 
        }
        #bubble::after {
            content: ''; position: absolute; 
            top: 100%; 
            left: 30px; 
            border-width: 15px 15px 0 0; 
            border-style: solid; 
            border-color: white transparent transparent transparent;
        }

        /* çŠ¶æ€æ–‡å­— */
        #status { 
            position: absolute; top: 20px; left: 20px; 
            color: #555; background: rgba(255,255,255,0.8); 
            padding: 8px 15px; border-radius: 20px; font-size: 14px;
        }
        
        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes breathe {
            0% { transform: scale(1, 1); }
            50% { transform: scale(1.02, 0.98); }
            100% { transform: scale(1, 1); }
        }
        @keyframes wave-anim {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
        .waving { animation: wave-anim 1s infinite !important; }

        .stop-breathing { animation: none !important; }

        /* ç…§ç‰‡ç»“æœé®ç½©å±‚ */
        #photo-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; flex-direction: column; z-index: 200;
        }
        #result-photo { 
            border: 10px solid white; max-width: 80%; max-height: 80%; 
            border-radius: 10px; transform: scaleX(-1); 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        .overlay-content { display: flex; flex-direction: column; align-items: center; }
        .btn-group { margin-top: 20px; display: flex; }
        button { 
            padding: 12px 30px; font-size: 18px; cursor: pointer; margin: 0 10px; 
            border: none; border-radius: 50px; background: white; color: #333; font-weight: bold;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        button:hover { background: #f0f0f0; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="input_video" autoplay playsinline muted></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <div id="pingu-container">
        <img id="pingu-character" src="pingu_idle.png" alt="Pingu">
        <img id="stationary-tripod" src="tripod_only.png" alt="Tripod"> 
    </div>

    <div id="bubble">...</div>

    <div id="status">æ­£åœ¨åŠ è½½ AI æ¨¡å‹...</div>

    <div id="photo-overlay">
        <div class="overlay-content">
            <img id="result-photo" src="">
            <div class="btn-group">
                <button onclick="downloadPhoto()">ğŸ’¾ ä¿å­˜ç…§ç‰‡</button>
                <button onclick="resetApp()">ğŸ”„ å†æ‹ä¸€å¼ </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. å˜é‡ä¸é…ç½®
        // ==========================================
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const pinguChar = document.getElementById('pingu-character');
        const stationaryTripod = document.getElementById('stationary-tripod');
        const bubble = document.getElementById('bubble');
        const statusDiv = document.getElementById('status');
        const pinguContainer = document.getElementById('pingu-container');
        
        let currentState = "LOADING"; 
    
        let waveCount = 0;
        let lastWristX = 0;
        let okGestureCount = 0;
        
        // ã€æ–°å¢ã€‘ç‚¹å¤´æ‘‡å¤´çš„è¿ç»­è®¡æ•°å™¨
        let nodFrameCount = 0;
        let shakeFrameCount = 0;
        const requiredGestureFrames = 5; // éœ€è¦è¿ç»­ 5 å¸§æ£€æµ‹åˆ°åŠ¨ä½œæ‰è§¦å‘

        // éŸ³é¢‘å˜é‡
        let cryAudio = new Audio('cry.mp3'); 
        cryAudio.loop = true; 
        
        let christmasAudio = new Audio('merry_christmas.mp3'); 
        christmasAudio.loop = true; 
        
        let cheerAudio = new Audio('cheer.mp3');

        let currentMainAudio = null; 
        
        // åŠ¨ç”»æ§åˆ¶å˜é‡
        let cryInterval = null; 
        let walkInterval = null; 
        let canRecoverFromCry = false; 

        // å¤´éƒ¨åŠ¨ä½œæ£€æµ‹å˜é‡
        let noseHistory = []; 
        const historyMaxLength = 10; 
        let headGestureCooldown = false; 

        // å…³é”®æµç¨‹å®šæ—¶å™¨
        let performanceTimeout = null; 
        let cryRecoveryTimeout = null; 
        let happyEndTimeout = null; 
        let sequenceTimeout = null; 

        // ==========================================
        // 2. è¯­éŸ³ä¸åŸºç¡€åŠŸèƒ½
        // ==========================================
        function speak(text) {
            bubble.innerText = text;
            bubble.style.opacity = 1;
            let audio = new Audio('noot.mp3');
            audio.volume = 0.8; 
            audio.play().catch(e => console.log("ç­‰å¾…äº¤äº’æ’­æ”¾å£°éŸ³"));
        }

        function showPhotoOverlay() {
            const overlay = document.getElementById('photo-overlay');
            overlay.style.display = 'flex';
            overlay.querySelector('.overlay-content').style.display = 'flex';
            bubble.style.opacity = 0; 
        }

        // ==========================================
        // 3. æ ¸å¿ƒæ£€æµ‹å¾ªç¯ (Pose)
        // ==========================================
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;

                if (currentState === "WAITING_WAVE") {
                    detectWave(landmarks);
                } 
                else if (currentState === "WAITING_OK") {
                    detectOK(landmarks);
                }
                else if (currentState === "WAITING_FOR_DECISION") {
                    updateNoseHistory(landmarks[0]); 
                    detectHeadGestures(); 
                }
                else if (currentState === "CRYING_TANTRUM") {
                    detectOK(landmarks);
                }
            }
            canvasCtx.restore();
        }

        // ==========================================
        // 4. åŠ¨ä½œæ£€æµ‹é€»è¾‘ (è¿›ä¸€æ­¥ä¼˜åŒ–)
        // ==========================================
        function detectWave(landmarks) {
            const wristX = landmarks[15].x; 
            const diff = Math.abs(wristX - lastWristX);
            if (diff > 0.05) { 
                waveCount++;
            }
            lastWristX = wristX;

            if (waveCount > 15) {
                if (currentState === "WAITING_WAVE") {
                    currentState = "TRANSITION";
                    pinguContainer.classList.add("waving");
                    speak("å¾ˆå¥½ï¼é‚£æˆ‘ä»¬ä¸€èµ·æ¥æ‹å¼ ç…§ç‰‡å§ï¼è¯·æ¯”å‡ºä¸€ä¸ª OK çš„æ‰‹åŠ¿ï¼");
                    setTimeout(() => {
                        currentState = "WAITING_OK";
                        waveCount = 0;
                    }, 4000);
                } 
                waveCount = 0; 
            }
        }

        function detectOK(landmarks) {
            const thumbTip = landmarks[21];
            const indexTip = landmarks[19];
            if (!thumbTip || !indexTip) return;

            const distance = Math.sqrt(Math.pow(thumbTip.x - indexTip.x, 2) + Math.pow(thumbTip.y - indexTip.y, 2));
            
            if (distance < 0.03) {
                okGestureCount++; 
                if (okGestureCount > 10) {
                    if (currentState === "WAITING_OK") {
                        console.log("æ£€æµ‹åˆ°OKï¼šæ‹ç…§");
                        takePhotoAction();
                        okGestureCount = 0; 
                    } 
                    else if (currentState === "CRYING_TANTRUM" && canRecoverFromCry) {
                          console.log("æ£€æµ‹åˆ°OKï¼šä»å“­æ³£æ¢å¤");
                          triggerHappyReaction();
                          okGestureCount = 0; 
                    }
                }
            } else {
                okGestureCount = 0; 
            }
        }

        function updateNoseHistory(noseLandmark) {
            if (!noseLandmark) return;
            noseHistory.push({x: noseLandmark.x, y: noseLandmark.y});
            if (noseHistory.length > historyMaxLength) noseHistory.shift(); 
        }

        // --- ã€ä¿®æ”¹ç‚¹ã€‘ç‚¹å¤´æ‘‡å¤´æ£€æµ‹ (å¢åŠ è®¡æ•°ç¡®è®¤é€»è¾‘) ---
        function detectHeadGestures() {
            if (headGestureCooldown || noseHistory.length < historyMaxLength) return;

            let xMovement = 0;
            let yMovement = 0;
            for (let i = 1; i < noseHistory.length; i++) {
                xMovement += Math.abs(noseHistory[i].x - noseHistory[i-1].x);
                yMovement += Math.abs(noseHistory[i].y - noseHistory[i-1].y);
            }

            const shakeThreshold = 0.15; 
            const nodThreshold = 0.12;   

            // åˆ¤æ–­æ‘‡å¤´
            if (xMovement > shakeThreshold && xMovement > yMovement * 1.5) {
                shakeFrameCount++;
                nodFrameCount = 0; // äº’æ–¥
                
                // åªæœ‰è¿ç»­æ£€æµ‹åˆ°ä¸€å®šæ¬¡æ•°ï¼Œæ‰è§¦å‘
                if (shakeFrameCount > requiredGestureFrames) {
                    triggerHeadAction("SHAKE");
                    shakeFrameCount = 0; // è§¦å‘åæ¸…é›¶
                }
            } 
            // åˆ¤æ–­ç‚¹å¤´
            else if (yMovement > nodThreshold && yMovement > xMovement * 1.5) {
                nodFrameCount++;
                shakeFrameCount = 0; // äº’æ–¥

                // åªæœ‰è¿ç»­æ£€æµ‹åˆ°ä¸€å®šæ¬¡æ•°ï¼Œæ‰è§¦å‘
                if (nodFrameCount > requiredGestureFrames) {
                    triggerHeadAction("NOD");
                    nodFrameCount = 0; // è§¦å‘åæ¸…é›¶
                }
            } 
            // ä»€ä¹ˆéƒ½æ²¡åš
            else {
                // å¦‚æœæ²¡æœ‰åŠ¨ä½œï¼Œè®¡æ•°å™¨å½’é›¶ (æˆ–è€…å¯ä»¥åšè¡°å‡ï¼Œè¿™é‡Œç›´æ¥å½’é›¶æ¯”è¾ƒä¸¥æ ¼)
                nodFrameCount = 0;
                shakeFrameCount = 0;
            }
        }

        function triggerHeadAction(type) {
            if (headGestureCooldown) return;
            headGestureCooldown = true; 
            setTimeout(() => {
                headGestureCooldown = false;
                noseHistory = []; 
            }, 1000);
            
            if (type === "NOD") {
                if (currentState === "WAITING_FOR_DECISION") {
                    triggerHappyReaction();
                } else if (currentState === "CRYING_TANTRUM" && canRecoverFromCry) {
                    triggerHappyReaction();
                }
            } else if (type === "SHAKE") {
                if (currentState === "WAITING_FOR_DECISION") {
                    triggerCryingTantrum();
                }
            }
        }

        // ==========================================
        // 5. å‰§æƒ…æµç¨‹æ§åˆ¶
        // ==========================================

        function takePhotoAction(isFinal = false) {
            if(currentState === "TAKING_PHOTO") return;
            currentState = "TAKING_PHOTO";

            pinguContainer.classList.remove("waving");
            
            if (!isFinal) {
                pinguChar.src = "pingu_camera.png";
                speak("ä¸‰ï¼ŒäºŒï¼Œä¸€ï¼ŒèŒ„å­ï¼");
            }

            setTimeout(() => {
                let shutterSound = new Audio('shutter.mp3');
                shutterSound.volume = 1.0;
                shutterSound.play().catch(e=>{});

                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                canvasCtx.save();
                canvasCtx.scale(-1, 1); 
                canvasCtx.drawImage(videoElement, -canvasElement.width, 0, canvasElement.width, canvasElement.height);
                canvasCtx.restore();

                const dataURL = canvasElement.toDataURL('image/png');
                document.getElementById('result-photo').src = dataURL;
                
                showPhotoOverlay();
                
                if (isFinal) {
                    if (cheerAudio) {
                        cheerAudio.volume = 1.0;
                        cheerAudio.currentTime = 0;
                        cheerAudio.play().catch(e => {});
                    }
                } 
                else {
                    if (currentMainAudio) currentMainAudio.pause();
                    currentMainAudio = new Audio('ending.mp3');
                    currentMainAudio.volume = 0.6;
                    currentMainAudio.play();

                    currentMainAudio.onended = () => {
                        const overlay = document.getElementById('photo-overlay');
                        overlay.style.display = 'none';
                        overlay.querySelector('.overlay-content').style.display = 'none';

                        pinguChar.src = "pingu_admire.png";
                        speak("æ‹å¾—çœŸå¥½çœ‹ï¼");

                        if (performanceTimeout) clearTimeout(performanceTimeout);
                        performanceTimeout = setTimeout(() => {
                            pinguChar.src = "pingu_expectant.png";
                            speak("æˆ‘å¯ä¸å¯ä»¥å’Œä½ ä»¬ä¸€èµ·å†æ‹ä¸€å¼ å‘€ï¼Ÿ");

                            console.log("åˆ‡æ¢çŠ¶æ€åˆ°ï¼šWAITING_FOR_DECISION"); 
                            pinguContainer.classList.add("stop-breathing");
                            currentState = "WAITING_FOR_DECISION";
                            noseHistory = []; 
                            
                            currentMainAudio = null;
                            performanceTimeout = null; 
                        }, 3000);
                    };
                } 
            }, isFinal ? 0 : 3000); 
        }

        function triggerHappyReaction() {
            if(currentState === "FINISHED") return; 
            currentState = "FINISHED"; 
            stopCryingTantrum(); 

            pinguChar.src = "pingu_happy.png"; 
            speak("å¥½è€¶ï¼"); 

            if (sequenceTimeout) clearTimeout(sequenceTimeout);
            sequenceTimeout = setTimeout(() => {
                startTripodSequence();
            }, 1500);
        }

        // --- æ¶è®¾ä¸‰è„šæ¶çš„æµç¨‹ ---
        function startTripodSequence() {
            speak("ç­‰æˆ‘ä¸€ä¸‹å“¦ï¼");
            
            pinguContainer.classList.add("stop-breathing");
            pinguContainer.style.transition = "transform 5s linear"; 

            const walkFramesLeft = [
                "pingu_walk_left_1.png", 
                "pingu_walk_idle.png", 
                "pingu_walk_left_2.png", 
                "pingu_walk_mid.png"
            ];
            let walkCounter = 0;

            if (walkInterval) clearInterval(walkInterval);
            walkInterval = setInterval(() => {
                pinguChar.src = walkFramesLeft[walkCounter];
                walkCounter = (walkCounter + 1) % walkFramesLeft.length;
            }, 250); 

            pinguContainer.style.transform = "translateX(-200%)";

            // --- 5ç§’åèµ°å›æ¥ ---
            sequenceTimeout = setTimeout(() => {
                pinguContainer.classList.add("no-transition");
                clearInterval(walkInterval); 
                
                let walkFrameBool = 0;
                walkInterval = setInterval(() => {
                    walkFrameBool = !walkFrameBool;
                    pinguChar.src = walkFrameBool ? "pingu_walk_tripod_1.png" : "pingu_walk_tripod_2.png";
                }, 400);

                speak("æˆ‘å›æ¥å•¦ï¼");
                void pinguContainer.offsetWidth; 

                pinguContainer.classList.remove("no-transition");
                pinguContainer.style.transition = "transform 5s linear"; 
                pinguContainer.style.transform = "translateX(0)"; 

                // --- 5ç§’åæ¶è®¾ä¸‰è„šæ¶ ---
                sequenceTimeout = setTimeout(() => {
                    clearInterval(walkInterval); 
                    
                    pinguChar.src = "pingu_place_tripod_1.png";
                    speak("å˜¿å’»...");

                    sequenceTimeout = setTimeout(() => {
                        pinguChar.src = "pingu_place_tripod_2.png"; 
                        
                        sequenceTimeout = setTimeout(() => {
                            pinguChar.src = "pingu_idle_tripod.png"; 
                            pinguContainer.classList.remove("stop-breathing"); 

                            // åˆ†æ®µè¯´è¯é€»è¾‘
                            speak("å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†ï¼Œæ‰€æœ‰çš„åœ£è¯æ ‘éƒ½æ˜¯æˆ‘çš„ä¼ é€é—¨ï¼");

                            sequenceTimeout = setTimeout(() => {
                                speak("çœ‹åˆ°æˆ‘èº«åçš„è¿™æ£µåœ£è¯æ ‘äº†å—ï¼Ÿæˆ‘ç­‰ä¼šå°±ä¼šèµ°è¿›å»ï¼");
                                
                                sequenceTimeout = setTimeout(() => {
                                    speak("è¯·ä½ ä¹Ÿå‡†å¤‡å¥½ä¸€æ£µåœ£è¯æ ‘ï¼Œæˆ‘ä»¬ä¸€èµ·å¿µå‡ºå’’è¯­â€œMerry Christmas!â€ï¼Œæˆ‘å°±å¯ä»¥è¢«ä¼ é€åˆ°ä½ èº«è¾¹å•¦ï¼");

                                    sequenceTimeout = setTimeout(() => {
                                        speak("é‚£æˆ‘å‡ºå‘å’¯ï¼");

                                        sequenceTimeout = setTimeout(() => {
                                            walkIntoTreeSequence();
                                        }, 2000);

                                    }, 6000);

                                }, 3500);

                            }, 3000);

                        }, 800);
                    }, 800);

                }, 5000); 

            }, 5000); 
        }

        // --- Pingu èµ°è¿›èƒŒæ™¯æ ‘å¹¶æ¶ˆå¤± ---
        function walkIntoTreeSequence() {
            console.log("å¯åŠ¨ï¼šèµ°è¿›ä¼ é€é—¨æµç¨‹");
            
            stationaryTripod.style.display = "block";
            pinguContainer.classList.add("stop-breathing");
            
            let walkFrame = 0;
            if (walkInterval) clearInterval(walkInterval);
            walkInterval = setInterval(() => {
                walkFrame = !walkFrame;
                pinguChar.src = walkFrame ? "pingu_back_1.png" : "pingu_back_2.png";
            }, 250);

            pinguChar.style.transition = "all 3s ease-in";
            pinguChar.style.transform = "translate(-500px, -220px) scale(0.2)";
            pinguChar.style.opacity = "0";

            // 3ç§’å Pingu å®Œå…¨æ¶ˆå¤±
            sequenceTimeout = setTimeout(() => {
                clearInterval(walkInterval); 
                
                speak("ç°åœ¨æˆ‘ä»¬ä¸€èµ·å¤§å£°è¯´å‡ºä¼ é€pinguçš„å’’è¯­å§ï¼");

                sequenceTimeout = setTimeout(() => {
                    speak("Merry Christmasï¼");
                    
                    if (christmasAudio) {
                        christmasAudio.volume = 0.6; 
                        christmasAudio.currentTime = 0;
                        christmasAudio.play().catch(e => console.log("åœ£è¯éŸ³ä¹æ’­æ”¾å¤±è´¥"));
                    }

                    sequenceTimeout = setTimeout(() => {
                        speak("æˆ‘æ¥å•¦ï¼");

                        sequenceTimeout = setTimeout(() => {
                            console.log("å¼€å§‹ 8ç§’ åœé¡¿...");
                            
                            sequenceTimeout = setTimeout(() => {
                                speak("ç°åœ¨æˆ‘ä»¬ä¸€èµ·æ‹ä¸‹è¿™å¼ æ¸©é¦¨çš„åœ£è¯åˆç…§å§ï¼3ï¼Œ2ï¼Œ1ï¼");

                                sequenceTimeout = setTimeout(() => {
                                    currentState = ""; 
                                    takePhotoAction(true); 
                                }, 3000);

                            }, 8000);

                        }, 2000); 

                    }, 3000); 

                }, 4000); 

            }, 3000);
        }

        function triggerCryingTantrum() {
            if (currentState === "CRYING_TANTRUM" || currentState === "FINISHED") return; 
            currentState = "CRYING_TANTRUM";
            canRecoverFromCry = false; 

            cryAudio.currentTime = 0;
            cryAudio.play().catch(e => {});
            
            if (cryRecoveryTimeout) clearTimeout(cryRecoveryTimeout);
            cryRecoveryTimeout = setTimeout(() => { 
                canRecoverFromCry = true; 
                cryRecoveryTimeout = null; 
            }, 4000);

            let isLegUp = false;
            if (cryInterval) clearInterval(cryInterval);
            cryInterval = setInterval(() => {
                pinguChar.src = isLegUp ? "pingu_cry_1.png" : "pingu_cry_2.png";
                isLegUp = !isLegUp;
            }, 200);
        }

        function stopCryingTantrum() {
            if (cryInterval) clearInterval(cryInterval); 
            cryAudio.pause(); 
            cryAudio.currentTime = 0; 
        }

        function downloadPhoto() {
            const link = document.createElement('a');
            link.download = 'pingu_photo.png';
            link.href = document.getElementById('result-photo').src;
            link.click();
        }

        function resetApp() {
            console.log("é‡ç½®åº”ç”¨...");
            
            if (performanceTimeout) clearTimeout(performanceTimeout);
            if (cryRecoveryTimeout) clearTimeout(cryRecoveryTimeout);
            if (happyEndTimeout) clearTimeout(happyEndTimeout);
            if (sequenceTimeout) clearTimeout(sequenceTimeout);
            if (walkInterval) clearInterval(walkInterval);

            // åœæ­¢æ‰€æœ‰éŸ³é¢‘
            if (currentMainAudio) {
                currentMainAudio.pause();
                currentMainAudio.currentTime = 0;
            }
            if (christmasAudio) {
                christmasAudio.pause();
                christmasAudio.currentTime = 0;
            }
            if (cheerAudio) {
                cheerAudio.pause();
                cheerAudio.currentTime = 0;
            }

            stopCryingTantrum();

            document.getElementById('photo-overlay').style.display = 'none';
            document.querySelector('.overlay-content').style.display = 'none';
            bubble.style.opacity = 0;

            // é‡ç½®ä¸‰è„šæ¶å’Œ Pingu çŠ¶æ€
            stationaryTripod.style.display = "none"; 
            
            pinguContainer.classList.add("no-transition");
            pinguContainer.style.transform = "translateX(0)";
            void pinguContainer.offsetWidth; 
            pinguContainer.classList.remove("no-transition");
            pinguContainer.style.transition = "transform 3s linear";
            
            pinguChar.style.transition = "transform 0.2s";
            pinguChar.style.transform = "none";
            pinguChar.style.opacity = "1";
            pinguChar.src = "pingu_idle.png";

            pinguContainer.classList.remove("stop-breathing");
            pinguContainer.classList.remove("waving");

            currentState = "WAITING_WAVE";
            waveCount = 0;
            noseHistory = [];
            headGestureCooldown = false;
            canRecoverFromCry = false;
            okGestureCount = 0;
            nodFrameCount = 0;
            shakeFrameCount = 0;

            speak("å¦‚æœä½ èƒ½çœ‹è§æˆ‘ï¼Œè¯·æŒ¥ä¸€æŒ¥æ‰‹ï¼");
        }

        // ==========================================
        // 7. åˆå§‹åŒ– Pose ä¸ Camera
        // ==========================================
        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                if (videoElement.readyState >= 2) { 
                    await pose.send({image: videoElement});
                }
            },
            width: 1280,
            height: 720
        });

        window.onload = function() {
            statusDiv.innerText = "è¯·æ±‚æ‘„åƒå¤´æƒé™...";
            speak("ä½ å¥½ï¼Œæ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·å…è®¸ä½¿ç”¨æ‘„åƒå¤´ã€‚");
            
            videoElement.setAttribute('autoplay', '');
            videoElement.setAttribute('playsinline', '');
            videoElement.setAttribute('muted', '');

            camera.start()
                .then(() => {
                    console.log("æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼");
                    statusDiv.innerText = "AI è¿è¡Œä¸­ | ç­‰å¾…æŒ¥æ‰‹";
                    videoElement.play().catch(e => {});
                    currentState = "WAITING_WAVE";
                    speak("ä½ å¥½ï¼Œå¦‚æœä½ èƒ½çœ‹è§æˆ‘ï¼Œè¯·æŒ¥ä¸€æŒ¥ä½ çš„æ‰‹ï¼");
                })
                .catch(err => {
                    console.error("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:", err);
                    statusDiv.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err;
                });
        };
    </script>
</body>
</html>