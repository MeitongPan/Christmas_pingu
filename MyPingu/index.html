<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pingu ç…§ç›¸æœº (æé€Ÿæ•‘æ€¥ç‰ˆ)</title>
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; height: 100vh; display: flex; justify-content: center; align-items: flex-end; }
        
        /* ã€å…³é”®ã€‘ç›´æ¥æ˜¾ç¤ºè§†é¢‘ï¼Œä¸åšå¤æ‚æ¸²æŸ“ */
        #video-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            /* å¦‚æœç”»é¢æ˜¯åçš„ï¼Œå¯ä»¥å»æ‰ä¸‹é¢è¿™è¡Œ */
            transform: scaleX(-1); 
            display: block;
        }

        /* éšè— Canvasï¼Œåªç”¨å®ƒåœ¨åå°å·å·è®¡ç®—ï¼Œä¸æ˜¾ç¤º */
        #output_canvas { display: none; }

        #pingu-container {
            position: relative; width: auto; height: 90vh;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 5vh; z-index: 10; pointer-events: none;
        }

        #pingu-character { height: 100%; width: auto; max-width: 90vw; object-fit: contain; }
        #stationary-tripod { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); height: 100%; width: auto; display: none; }
        
        #bubble {
            background: white; padding: 15px 25px; border-radius: 20px;
            position: fixed; top: 70px; left: 20px; max-width: 300px;
            font-size: 18px; font-weight: bold; color: #333; z-index: 50;
            opacity: 0; transition: opacity 0.5s; font-family: sans-serif;
        }

        #status { 
            position: absolute; top: 20px; left: 20px; 
            color: #fff; background: rgba(0,0,0,0.5); 
            padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 100;
        }

        #photo-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; z-index: 200;
            justify-content: center; align-items: center; flex-direction: column;
        }
        #result-photo { max-width: 80%; max-height: 80%; border: 5px solid white; transform: scaleX(-1); }
        .btn-group { margin-top: 20px; }
        button { padding: 12px 25px; font-size: 16px; cursor: pointer; border-radius: 20px; border: none; margin: 0 10px; }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="input_video" playsinline muted></video>
    </div>
    
    <canvas id="output_canvas"></canvas>

    <div id="pingu-container">
        <img id="pingu-character" src="pingu_idle.png" alt="Pingu">
        <img id="stationary-tripod" src="tripod_only.png" alt="Tripod"> 
    </div>

    <div id="bubble">...</div>
    <div id="status">åˆå§‹åŒ–æé€Ÿæ¨¡å¼...</div>

    <div id="photo-overlay">
        <img id="result-photo" src="">
        <div class="btn-group">
            <button onclick="downloadPhoto()">ğŸ’¾ ä¿å­˜</button>
            <button onclick="location.reload()">ğŸ”„ é‡æ¥</button>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const pinguChar = document.getElementById('pingu-character');
        const stationaryTripod = document.getElementById('stationary-tripod');
        const bubble = document.getElementById('bubble');
        const statusDiv = document.getElementById('status');
        const pinguContainer = document.getElementById('pingu-container');
        
        let currentState = "LOADING"; 
        let waveCount = 0; let lastWristX = 0;
        let okGestureCount = 0;
        let noseHistory = []; 
        let headGestureCooldown = false;
        let nodFrameCount = 0; let shakeFrameCount = 0;

        // éŸ³é¢‘
        let nootAudio = new Audio('noot.mp3');
        let shutterAudio = new Audio('shutter.mp3');
        let christmasAudio = new Audio('merry_christmas.mp3'); christmasAudio.loop = true;
        let cheerAudio = new Audio('cheer.mp3');
        let cryAudio = new Audio('cry.mp3'); cryAudio.loop = true;

        function speak(text) {
            bubble.innerText = text;
            bubble.style.opacity = 1;
            nootAudio.play().catch(e=>{});
        }

        function onResults(results) {
            if(currentState === "LOADING") {
                statusDiv.innerText = "æé€Ÿæ¨¡å¼è¿è¡Œä¸­ | ç­‰å¾…æŒ¥æ‰‹";
            }
            // æ³¨æ„ï¼šè¿™é‡Œä¸å†è¿›è¡Œ canvas ç»˜å›¾ï¼Œæå¤§èŠ‚çœæ€§èƒ½
            if (results.poseLandmarks) {
                const lm = results.poseLandmarks;
                if (currentState === "WAITING_WAVE") detectWave(lm);
                else if (currentState === "WAITING_OK") detectOK(lm);
                else if (currentState === "WAITING_FOR_DECISION") {
                    updateNose(lm[0]); detectHead();
                } else if (currentState === "CRYING") {
                    detectOK(lm);
                }
            }
        }

        function detectWave(lm) {
            let wristX = lm[15].x;
            if (Math.abs(wristX - lastWristX) > 0.05) waveCount++;
            lastWristX = wristX;
            if (waveCount > 15) {
                currentState = "TRANSITION";
                pinguContainer.classList.add("waving"); // ç®€å•çš„CSSåŠ¨ç”»
                speak("çœ‹åˆ°ä½ å•¦ï¼è¯·æ¯”ä¸ª OK çš„æ‰‹åŠ¿ï¼");
                setTimeout(() => { currentState = "WAITING_OK"; waveCount = 0; }, 3000);
            }
        }

        function detectOK(lm) {
            let dist = Math.hypot(lm[21].x - lm[19].x, lm[21].y - lm[19].y);
            if (dist < 0.05) { // æ”¾å®½ä¸€ç‚¹åˆ¤å®š
                okGestureCount++;
                if (okGestureCount > 5) { // å‡å°‘åˆ¤å®šå¸§æ•°
                    if(currentState === "WAITING_OK") takePhoto();
                    else if(currentState === "CRYING") happyReaction();
                    okGestureCount = 0;
                }
            } else okGestureCount = 0;
        }

        function updateNose(nose) {
            if(!nose) return;
            noseHistory.push(nose);
            if(noseHistory.length > 10) noseHistory.shift();
        }

        function detectHead() {
            if(headGestureCooldown || noseHistory.length < 10) return;
            let xMove = 0, yMove = 0;
            for(let i=1; i<noseHistory.length; i++) {
                xMove += Math.abs(noseHistory[i].x - noseHistory[i-1].x);
                yMove += Math.abs(noseHistory[i].y - noseHistory[i-1].y);
            }
            if(xMove > 0.15 && xMove > yMove * 1.5) {
                shakeFrameCount++; nodFrameCount = 0;
                if(shakeFrameCount > 3) triggerAction("SHAKE");
            } else if(yMove > 0.12 && yMove > xMove * 1.5) {
                nodFrameCount++; shakeFrameCount = 0;
                if(nodFrameCount > 3) triggerAction("NOD");
            } else { shakeFrameCount=0; nodFrameCount=0; }
        }

        function triggerAction(type) {
            headGestureCooldown = true;
            setTimeout(() => { headGestureCooldown = false; noseHistory = []; }, 1000);
            if(type === "NOD") happyReaction();
            else if(type === "SHAKE") triggerCrying();
        }

        function triggerCrying() {
            if(currentState === "CRYING") return;
            currentState = "CRYING";
            pinguChar.src = "pingu_cry_1.png";
            cryAudio.play().catch(e=>{});
        }

        function happyReaction() {
            if(currentState === "FINISHED") return;
            currentState = "FINISHED";
            cryAudio.pause(); cryAudio.currentTime=0;
            pinguChar.src = "pingu_happy.png";
            speak("å¥½è€¶ï¼");
            setTimeout(startSequence, 1500);
        }

        function startSequence() {
            // ç®€åŒ–ç‰ˆæµç¨‹
            speak("ç­‰æˆ‘ä¸€ä¸‹å“¦ï¼");
            pinguContainer.style.transition = "transform 3s linear";
            pinguContainer.style.transform = "translateX(-200%)"; 
            
            setTimeout(() => {
                pinguContainer.style.transition = "none";
                pinguContainer.style.transform = "translateX(0)";
                speak("æˆ‘å›æ¥å•¦ï¼");
                stationaryTripod.style.display = "block"; 
                pinguChar.style.opacity = 0; 
                
                speak("ç°åœ¨æˆ‘ä»¬ä¸€èµ·å¤§å£°è¯´å‡ºä¼ é€pinguçš„å’’è¯­å§ï¼");
                
                setTimeout(() => {
                    speak("Merry Christmasï¼");
                    christmasAudio.play().catch(e=>{});
                    setTimeout(() => {
                        speak("æˆ‘æ¥å•¦ï¼");
                        setTimeout(() => {
                            speak("å‡†å¤‡æ‹ç…§ï¼3ï¼Œ2ï¼Œ1ï¼");
                            setTimeout(() => {
                                takePhoto(true);
                            }, 3000);
                        }, 8000);
                    }, 3000);
                }, 4000);
            }, 3000);
        }

        function takePhoto(isFinal = false) {
            shutterAudio.play();
            
            // åªæœ‰æ‹ç…§è¿™ä¸€ç¬é—´ï¼Œæ‰ä½¿ç”¨ canvas ç»˜åˆ¶ä¸€å¸§
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasCtx.drawImage(videoElement, 0, 0); 
            
            document.getElementById('result-photo').src = canvasElement.toDataURL('image/png');
            document.getElementById('photo-overlay').style.display = 'flex';
            
            if(isFinal) {
                cheerAudio.play();
            } else {
                 speak("æ‹å¾—çœŸå¥½ï¼");
                 setTimeout(() => {
                     document.getElementById('photo-overlay').style.display = 'none';
                     currentState = "WAITING_FOR_DECISION";
                     pinguChar.src = "pingu_expectant.png";
                     speak("å†æ‹ä¸€å¼ å—ï¼Ÿ(ç‚¹å¤´/æ‘‡å¤´)");
                 }, 3000);
            }
        }
        
        function downloadPhoto() {
            const a = document.createElement('a');
            a.download = 'pingu.png';
            a.href = document.getElementById('result-photo').src;
            a.click();
        }

        // åˆå§‹åŒ–
        const pose = new Pose({locateFile: (file) => `https://unpkg.com/@mediapipe/pose/${file}`});
        // ã€æé€Ÿç‰ˆæ ¸å¿ƒè®¾ç½®ã€‘modelComplexity: 0 (è¶…è½»é‡æ¨¡å‹)ï¼Œ0 æ˜¯æœ€å¿«æœ€ä¸åƒé…ç½®çš„
        pose.setOptions({ 
            modelComplexity: 0, 
            smoothLandmarks: true, 
            enableSegmentation: false, 
            minDetectionConfidence: 0.5, 
            minTrackingConfidence: 0.5 
        });
        pose.onResults(onResults);

        // ä½¿ç”¨æœ€ä½åˆ†è¾¨ç‡ 640x480 ä»¥ä¿è¯æµç•…
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: "user" }, audio: false })
            .then(stream => {
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    
                    const loop = async () => {
                        await pose.send({image: videoElement});
                        requestAnimationFrame(loop);
                    };
                    loop();
                };
            })
            .catch(err => {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err);
            });
    </script>
</body>
</html>